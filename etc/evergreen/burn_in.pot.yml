name: burn_in
bonsai:
  - source: local
    path: etc/evergreen/python.pot.yml

  - source: local
    path: etc/evergreen/evg_api.pot.yml

  - source: local
    path: etc/evergreen/multiversion.pot.yml

functions:
  burn_in_tests:
    description: Generate dynamic tasks to burn in changed tests
    actions:
      - bonsai: python:set up venv
      - bonsai: evg_api:configure api credentials
      - bonsai: multiversion:setup
      - command: expansions.write
        params:
          file: expansions.yml
      - command: subprocess.exec
        type: test
        params:
          binary: bash
          args:
            - "src/evergreen/burn_in_tests.sh"
          env:
            python: ${python}
            workdir: ${workdir}
      - command: archive.targz_pack
        params: 
          target: src/burn_in_tests_gen.tgz
          source_dir: src
          include:
            - burn_in_tests_gen.json
      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/burn_in_tests_gen.tgz
          remote_file: ${project}/${build_variant}/${revision}/burn_in_tests_gen/burn_in_tests_gen-${build_id}.tgz
          bucket: mciuploads
          permissions: public-read
          content_type: application/gzip
          display_name: Burn_in_tests Task Config - Execution ${execution}
      - command: generate.tasks
        params:
          files:
            - src/burn_in_tests_gen.json

  burn_in_multiversion_tests:
    description: Generate dynamic tests to test multiversiont test changes
    actions:
      - bonsai: python:set up venv
      - bonsai: evg_api:configure api credentials
      - bonsai: multiversion:setup
      - command: expansions.write
        params:
          file: expansions.yml
      - command: subprocess.exec
        type: test
        params:
          binary: bash
          args:
            - "src/evergreen/burn_in_tests_multiversion.sh"
          env:
            python: ${python}
            workdir: ${workdir}

      - command: archive.targz_pack
        params:
          target: src/burn_in_tests_multiversion_gen.tgz
          source_dir: src
          include:
            - burn_in_tests_multiversion_gen.json

      - command: archive.targz_pack
        params:
          target: generate_tasks_config.tgz
          source_dir: src/generated_resmoke_config
          include:
            - "*"

      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: generate_tasks_config.tgz
          remote_file: ${project}/${build_variant}/${revision}/generate_tasks/burn_in_tests_multiversion_gen-${build_id}.tgz
          bucket: mciuploads
          permissions: public-read
          content_type: application/gzip
          optional: true
          display_name: Generated Multiversion Resmoke.py Suite Config - Execution ${execution}

      - command: s3.put
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          local_file: src/burn_in_tests_multiversion_gen.tgz
          remote_file: ${project}/${build_variant}/${revision}/generate_tasks/burn_in_tests_multiversion_gen_config-${build_id}.tgz
          bucket: mciuploads
          permissions: public-read
          content_type: application/gzip
          display_name: Burn_in_tests Task Config - Execution ${execution}

      - command: generate.tasks
        params:
          files:
            - src/burn_in_tests_multiversion_gen.json
