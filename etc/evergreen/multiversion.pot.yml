name: multiversion
functions:
  setup:
    description: Download and setup the binaries needed to perform multiversion tests.
    parameters:
      - name: install_master_bin
        description: |
          This is primarily for tests for infrastructure which don't always need the latest
          binaries.
    actions:
    - command: shell.exec
      params:
        working_dir: src
        shell: bash
        script: |
          set -o errexit
          set -o verbose

          ${activate_virtualenv}

          rm -rf /data/install /data/multiversion

          edition="${multiversion_edition|base}"
          platform="${multiversion_platform|linux_x86_64}"
          architecture="${multiversion_architecture|x86_64}"

          $python buildscripts/resmoke.py setup-multiversion   \
            --installDir /data/install                         \
            --linkDir /data/multiversion                       \
            --edition $edition                                 \
            --platform $platform                               \
            --architecture $architecture                       \
            --githubOauthToken "${github_token}"               \
            --useLatest 3.6 4.0

          # The platform and architecture for how some of the binaries are reported in
          # https://downloads.mongodb.org/full.json changed between MongoDB 4.0 and MongoDB 4.2.
          # Certain build variants define additional multiversion_*_42_or_later expansions in order to
          # be able to fetch a complete set of versions.

          if [ ! -z "${multiversion_edition_42_or_later}" ]; then
            edition="${multiversion_edition_42_or_later}"
          fi

          if [ ! -z "${multiversion_platform_42_or_later}" ]; then
            platform="${multiversion_platform_42_or_later}"
          fi

          if [ ! -z "${multiversion_architecture_42_or_later}" ]; then
            architecture="${multiversion_architecture_42_or_later}"
          fi

          $python buildscripts/resmoke.py setup-multiversion   \
            --installDir /data/install                         \
            --linkDir /data/multiversion                       \
            --edition $edition                                 \
            --platform $platform                               \
            --architecture $architecture                       \
            --githubOauthToken "${github_token}"               \
            --useLatest 4.2 4.2.1

          # The platform and architecture for how some of the binaries are reported in
          # https://downloads.mongodb.org/full.json changed between MongoDB 4.2 and MongoDB 4.4.
          # Certain build variants define additional multiversion_*_44_or_later expansions in order to
          # be able to fetch a complete set of versions.

          if [ ! -z "${multiversion_edition_44_or_later}" ]; then
            edition="${multiversion_edition_44_or_later}"
          fi

          if [ ! -z "${multiversion_platform_44_or_later}" ]; then
            platform="${multiversion_platform_44_or_later}"
          fi

          if [ ! -z "${multiversion_architecture_44_or_later}" ]; then
            architecture="${multiversion_architecture_44_or_later}"
          fi

          $python buildscripts/resmoke.py setup-multiversion   \
            --installDir /data/install                         \
            --linkDir /data/multiversion                       \
            --edition $edition                                 \
            --platform $platform                               \
            --architecture $architecture                       \
            --githubOauthToken "${github_token}"               \
            --useLatest 4.4 4.7 4.8 4.9

          # This is primarily for tests for infrastructure which don't always need the latest
          # binaries.
          if [ ! -z "${install_master_bin}" ]; then
            $python buildscripts/resmoke.py setup-multiversion   \
              --installDir /data/install                         \
              --linkDir /data/multiversion                       \
              --edition $edition                                 \
              --platform $platform                               \
              --architecture $architecture                       \
              --githubOauthToken "${github_token}"               \
              --useLatest master
          fi
